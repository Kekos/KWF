/*!
 * KWF Script: kwf.js
 * Based on DOMcraft
 * 
 * @author Christoffer Lindahl <christoffer@kekos.se>
 * @date 2013-05-09
 * @version 5.0
 */
(function(k,p){var t=function(w){try{return new t.p.element(w)}catch(x){return null}},l=null,f=null,o,d,n,b,s,v,e,i,j,q,h,r,a;if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}function c(w){if(!w.preventDefault){w.preventDefault=function(){event.returnValue=false}}if(!w.stopPropagation){w.stopPropagation=function(){w.cancelBubble=true}}if(!w.target){w.target=event.srcElement}}function m(w){if(w.target.nodeName.match(/button|input/i)&&w.target.type==="submit"){this.submitter=w.target}}function g(y){if(y.button<1){var x=t(y.target),w=0;if(x.hasClass("content-context")){w=1;h.fromLink(x)}else{if(x.hasClass("boxing-context")){w=1;r.fromLink(x)}}if(f){w|=f(y,x)}if(w){y.preventDefault()}}}function u(x){if(p.addEventListener||x.type==="load"||p.readyState==="complete"){if(p.addEventListener){p.removeEventListener("DOMContentLoaded",u,0);k.removeEventListener("load",u,0)}else{p.detachEvent("onreadystatechange",u);k.detachEvent("onload",u)}var w;for(w=0;w<l.length;w++){l[w]()}l=null}}t.p=t.prototype={element:function(w){this.elem=null;if(w.nodeType||w===k){this.elem=w}else{if(typeof w==="string"){try{this.elem=p.getElementById(w)||p.all[w];if(!this.elem){throw new Error("Could not find element #"+w)}}catch(x){throw new Error("Could not find element #"+w)}}}},hasClass:function(w){return(this.elem.className?Boolean(this.elem.className.match(new RegExp("(\\s|^)"+w+"(\\s|$)"))):false)},addClass:function(w){if(!this.hasClass(w)){this.elem.className+=" "+w}},removeClass:function(w){this.elem.className=this.elem.className.replace(new RegExp("(\\s|^)"+w+"(\\s|$)")," ").replace(/\s+/g," ").replace(/^\s|\s$/,"")},replaceClass:function(w,x){this.removeClass(w);this.addClass(x)},parent:function(){return t(this.elem.parentNode)},query:function(w){return t(this.elem.querySelector(w))},queryAll:function(z){var x=[],y,w=this.elem.querySelectorAll(z);for(y=0;y<w.length;y++){x.push(t(w[y]))}return x},insertBefore:function(w,x){if(w instanceof t){w=w.elem}if(x instanceof t){x=x.elem}this.elem.insertBefore(w,x)},prepend:function(w){this.insertBefore(w,this.elem.firstChild)},append:function(w){if(w instanceof t){w=w.elem}this.elem.appendChild(w)},remove:function(){this.elem.parentNode.removeChild(this.elem)},empty:function(){while(this.elem.hasChildNodes()&&this.elem.removeChild(this.elem.firstChild)){}},html:function(w){if(typeof w==="string"){this.elem.innerHTML=w}else{return this.elem.innerHTML}},text:function(w){var x=(this.elem.textContent!==undefined?"textContent":"innerText");if(typeof w==="string"){this.elem[x]=w}else{return this.elem[x]}},value:function(w){if(this.elem.value===undefined){throw new Error("value(): Tried to set value on non-form element")}else{if(w!==undefined){this.elem.value=w}else{return this.elem.value}}},attr:function(x,w){if(typeof w!=="undefined"){this.elem.setAttribute(x,w)}else{return this.elem.getAttribute(x)}},style:function(x,w){try{if(typeof w!=="undefined"){this.elem.style[x]=w}else{return this.elem.style[x]}}catch(y){throw new Error("style(): Could not find property: "+x)}},offsetTop:function(){var x=this.elem.offsetTop,w=this.elem.offsetParent;while(w){x+=w.offsetTop;w=w.offsetParent}return x},offsetLeft:function(){var x=this.elem.offsetLeft,w=this.elem.offsetParent;while(w){x+=w.offsetLeft;w=w.offsetParent}return x},addEvent:function(A,z,y,x){var C=z,B,w=this;if(x){C=function(D){z.call(x,D)}}B=function(D){c(D);C.call(w.elem,D)};if(A==="submit"){w.addEvent("click",m)}if(w.elem.addEventListener){w.elem.addEventListener(A,B,y)}else{if(w.elem.attachEvent){w.elem.attachEvent("on"+A,B)}}}};t.p.element.prototype=t.p;t.create=function(z,w){var x=new t.p.element(p.createElement(z)),y;if(w){for(y in w){if(y==="id"){x.elem.id=w.id}else{if(y==="class"){x.elem.className=w["class"]}else{x.attr(y,w[y])}}}}return x};t.ready=o=function(w){if(!l){l=[];if(p.readyState==="complete"){setTimeout(complete)}else{if(p.addEventListener){p.addEventListener("DOMContentLoaded",u,0);k.addEventListener("load",u,0)}else{p.attachEvent("onreadystatechange",u);k.attachEvent("onload",u)}}}if(typeof w==="function"){l.push(w)}else{throw new Error("ready(): listener must be a function.")}};t.click=function(w){if(typeof w==="function"){f=w}else{throw new Error("click(): listener must be a function.")}};t.parseJSON=b=function(w){if(k.JSON&&JSON.parse){w=JSON.parse(w)}else{if(typeof w==="string"){try{w=(new Function("return "+w))()}catch(x){}}}return w};t.__=function(w){if(t.languages[w]){return t.languages[w]}return w};t.var_dump=function(x,C){function w(D){var E,F="";for(E=0;E<(D*2);E++){F+=" "}return F}var A=typeof x,B="",z;if(!C){C=1}else{if(C>5){return""}}if(A==="object"){B+="{\n";for(z in x){try{B+=w(C)+z+": "+t.var_dump(x[z],C+1)}catch(y){}}B+=w(C)+"}"}else{B=x.toString()}B="("+A+") "+B+"\n";if(C===1){alert(B)}else{return B}};t.toDOMnode=d=function(w){var x=p.createElement("div");x.innerHTML=w.trim();return t(x.firstChild)};t.htmlSpecialChars=n=function(w){return w.replace(/>/gm,"&gt;").replace(/</gm,"&lt;").replace(/"/gm,"&quot;")};t.Ajax=s=(function(){var x=null,B=null;function z(H,G,R,L,O,I,M){var J=(k.ActiveXObject)?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest(),N,Q=0,P;J.open(G,H);J.setRequestHeader("X-ajax-request","true");if(typeof I==="object"){for(P in I){if(I[P][0]==="Content-Type"){Q=1}J.setRequestHeader(I[P][0],I[P][1])}}if(!Q&&!M){J.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=utf-8")}J.onreadystatechange=function(){if(J.readyState===4){Q=J.getResponseHeader("Content-Type");Q=Q.substring(0,Q.indexOf(";"));N={page:J.responseText,content_type:Q,status:J.status};if(N.content_type==="application/json"){N.page=b(N.page)}if(B){B()}if(J.status===200){N.success=1;R(N)}else{if(J.status===404){N={success:0,page:{error:["Filen hittades inte."]},content_type:"application/json",status:"404"};L(N)}}}};if(x){x()}J.send(O)}function C(I){var H="",G;for(G in I){H+="&"+G+"="+encodeURIComponent(I[G])}return H.substring(1)}function A(N,L){var O="",H=N.getElementsByTagName("input"),J=N.getElementsByTagName("select"),G=N.getElementsByTagName("textarea"),I;function M(P){return(P.name===""?"":"&"+P.name+"="+encodeURIComponent(P.value))}if(N){for(I=0;I<H.length;I++){if(((H[I].type==="radio"||H[I].type==="checkbox")&&!H[I].checked)||(H[I].type==="button"||H[I].type==="submit")){continue}O+=M(H[I])}for(I=0;I<J.length;I++){O+=M(J[I])}for(I=0;I<G.length;I++){O+=M(G[I])}}if(L){O+=M(L)}return O.substring(1)}function y(H,J,G,I){if(typeof I==="object"){I=C(I)}if(I){I="?"+I}else{I=""}z(H+I,"GET",J,G,null)}function D(H,L,G,J,I){J=(J.nodeType?A(J,I):C(J));z(H,"POST",L,G,J)}function F(H,U,L,T){if(k.FormData!==undefined&&k.File!==undefined){var P,N,Q;if(T instanceof FormData){P=T}else{P=new FormData();Q=T.name+(T.files.length>1?"[]":"");for(N=0;N<T.files.length;N++){P.append(Q,T.files[N])}}z(H,"POST",U,L,P,[],1)}else{var S=T.parentNode,I,J,G,O=t(p.body),M,R=0;if(x){x()}I=d('<form style="visibility: hidden;" action="'+H+'" method="post" enctype="multipart/form-data" target="ajax_upload_frame"><input type="hidden" name="X-ajax-request" value="true" /><input type="hidden" name="X-frame-upload" value="true" /></form>');O.append(I);S.removeChild(T);I.append(T);J=d('<iframe style="visibility: hidden;" src="javascript: false;" name="ajax_upload_frame" id="ajax_upload_frame"></iframe>');O.append(J);J.addEvent("load",function(){setTimeout(function(){G=J.elem.contentDocument||J.elem.contentWindow.document;M=G.body.firstChild.nodeValue;if(M===null){M=G.body.innerHTML}if(M.substring(0,1)==="{"&&M.substring(M.length-1)==="}"){R=1}U({page:(R?b(M):M),content_type:(R?"application/json":"text/plain"),status:"200"});J.remove();if(B){B()}},1)});I.elem.submit();I.remove();S.appendChild(T)}}function w(G){x=G}function E(G){B=G}return{get:y,post:D,upload:F,setBeforeCallback:w,setAfterCallback:E}}());t.DialogManager=v=(function(){var w=[],y=100,A=null;function B(){if(w.length){return w[w.length-1]}return null}function C(G){var F=G.getContainer();A=p.activeElement;F.tabIndex=-1;F.focus();F.style.zIndex=y+w.length;w.push(G)}function z(){w.pop();if(A){A.focus()}else{if(w.length){B().getContainer().focus()}}}function E(F){var G=B();if(G===F){G.close();z()}}function D(F){if(F.keyCode===27&&w.length){B().close();z()}}function x(G){if(w.length){var F=B().getContainer();if(!F.contains(G.target)){G.stopPropagation();F.focus()}}}t(p).addEvent("keyup",D);t(p).addEvent("focus",x,1);t(p).addEvent("focusin",x);return{addDialog:C,removeDialog:z,requestRemoval:E}}());t.Boxing=e=(function(){var w=0,z=null,x=null,A=null,y=null,B=null;function C(){return y}function E(){if(B){if(!B()){return}}x.style.display="none";A.style.display="none";y.style.display="none";y.innerHTML="";z.style.overflow="";B=null;w=0}t.ready(function(){var F=p.body;x=p.createElement("div");y=p.createElement("div");A=p.createElement("a");x.id="boxing-overlayer";F.appendChild(x);t(x).addEvent("click",function(){v.requestRemoval(e)});A.id="close_boxing";A.className="hide-boxing";A.href="javascript: void(0);";A.innerHTML="X";F.appendChild(A);y.setAttribute("role","dialog");y.id="boxing-window";F.appendChild(y);t(F).addEvent("click",function(G){if(t(G.target).hasClass("hide-boxing")){G.preventDefault();v.requestRemoval(e)}});z=p.getElementsByTagName("HTML")[0];E()});function D(J,H,F,L){if(L){B=L}var I=(H>100?"px":"%"),G=(F>100?"px":"%");x.style.display="block";A.style.display="block";y.style.display="block";y.style.width=H+I;y.style.height=F+G;if(G==="%"){y.style.margin="0 0 0 -"+(H/2)+I;y.style.top=(100-F)/2+"%"}else{y.style.margin="-"+(F/2)+G+" 0 0 -"+(H/2)+I;y.style.top="50%"}y.innerHTML=J;A.style.top=y.offsetTop-10+"px";A.style.left=y.offsetLeft+y.offsetWidth-10+"px";z.style.overflow="hidden";if(!w){v.addDialog(e)}w=1}return{show:D,close:E,getContainer:C}}());t.Dialog=i=function(C,A,x,D,z){var F=this,B=p.createElement("div"),w=null,y=Math.floor(Math.random()*1000);function E(G){if(t(G.target).hasClass("dialog-close")){v.requestRemoval(F)}if(typeof z==="function"){z(G)}}F.setContent=function(G){if(typeof G==="string"){w.innerHTML+=G}else{w.innerHTML="";w.appendChild(G)}};F.getContainer=function(){return w};F.close=function(){B.parentNode.removeChild(B)};B.setAttribute("role","dialog");B.setAttribute("aria-labelledby","kwf_dlgtitle_"+y);B.className="kwf-dialog";B.style.width=x+"px";B.style.height=D+"px";B.style.margin="-"+(D/2)+"px 0 0 -"+(x/2)+"px";B.innerHTML='<div class="kwf-dialog-bar"><span class="kwf-dialog-title" id="kwf_dlgtitle_'+y+'">'+C+'</span><span class="kwf-dialog-close dialog-close">X</span></div>';w=B.appendChild(d('<div class="kwf-dialog-content"></div>').elem);F.setContent(A);p.body.appendChild(B);v.addDialog(F);t(B).addEvent("click",E)};t.MessagesView=a=(function(){var y=null;function C(){y=t("kwf_messages_view");if(y&&y.elem.children.length){setTimeout(function(){y.empty()},10000)}}function A(E,F){var D;if(typeof F==="string"){F=[F]}if(!y){y=t.create("ul",{id:"kwf_messages_view"});t("content").prepend(y)}for(D=0;D<F.length;D++){(function(){var G=d('<li class="kwf-'+E+'">'+F[D]+"</li>");y.append(G.elem);setTimeout(function(){G.remove()},10000)}())}}function x(D){A("error",D)}function w(D){A("info",D)}function z(H){t.MessagesView.removeFormErrors();if(H.errors){x(H.errors)}if(H.info){w(H.info)}if(H.form_errors){var L=H.form_errors,F,G,D,E,J=1;for(F in L){D=t(F);E=D.elem.parentNode.getElementsByTagName("label")[0];G=t.create("strong",{"class":"form-error"});G.html(L[F]);try{if(J){J=0;D.elem.focus()}E.appendChild(G.elem)}catch(I){console.error("MessagesView: Element "+F+" not found in page")}}}}function B(){var E=K(p).queryAll(".form-error"),D=0;while(E[D]){E[D].remove();++D}}return{init:C,addError:x,addInfo:w,fromResponse:z,removeFormErrors:B}}());t.EventTarget=j=function(){this.listeners={};this.addEvent=function(w,x){if(this.listeners[w]===undefined){this.listeners[w]=[]}this.listeners[w].push(x)};this.removeEvent=function(y,z){if(this.listeners[y] instanceof Array){var w=this.listeners[y],x;for(x=0;x<w.length;x++){if(String(w[x])===String(z)){w.splice(x,1);break}}}};this.dispatchEvent=function(y,A){if(typeof y==="string"){y={type:y};if(A!==undefined){y.target=A}}if(!y.target){y.target=this}if(!y.type){alert('Request Event object missing "type" property.')}y.defaultPrevented=false;y.preventDefault=function(){y.defaultPrevented=true};if(this.listeners[y.type] instanceof Array){var w=this.listeners[y.type],x;for(x=0;x<w.length;x++){try{w[x].call(this,y)}catch(z){throw new Error("Event "+y.type+": "+z.message+" at line "+(z.lineNumber||"null")+" in file "+(z.fileName||"null"))}}}return y.defaultPrevented}};t.Context=q=function(z){var y=function(){},x=this;j.call(x);(function(){if(!z.elem){z=t(z)}w()}());function w(){var B=z.elem.getElementsByTagName("form"),C,D;function A(F){var E=F.target;F.preventDefault();if(E.submitter){E.submitter.disabled="disabled"}x.request(E.action,E)}for(C=0;C<B.length;C++){D=t(B[C]);if(D.hasClass("ajax-form")){D.addEvent("submit",A);D.removeClass("ajax-form")}}}this.onFailure=function(A){if(typeof A!=="function"){throw new Error("onFailure listener must be a function.")}y=A};this.request=function(B,C){var A=this;function D(E){A.parseResponse({url:B,data:C},E)}if(C){if(C.type==="file"){s.upload(B,D,y,C)}else{s.post(B,D,y,C,C.submitter)}}else{s.get(B,D,y)}};this.parseResponse=function(C,A){var B={type:"afterload",request:C,target:A};if(A.page.content_type==="application/json"){A.page.content=b(A.page.content)}if(!this.dispatchEvent(B)){if(A.content_type==="application/json"){if(String(A.page.content_type).indexOf("text/")===0){z.html(A.page.content)}t.MessagesView.fromResponse(A.page)}else{z.html(A.page)}w.call(this);if(C.data&&C.data.submitter){C.data.submitter.disabled=""}B.type="ready";this.dispatchEvent(B)}}};q.prototype=new j();t.ready(function(){if(t("content")){h=new q(t("content"));h.addEvent("ready",function(y){if(y.request){var x=y.request.url;k.scrollTo(0,0);if(!this.fromHistory){if(history.pushState){history.pushState({url:x},null,x)}else{this.ignore_hash_change=1;location.hash="#"+x}}this.fromHistory=0}});h.fromLink=function(x){this.request(x.attr("href"),null)};h.noHistory=function(x,y){h.fromHistory=1;h.request(x,y)};(function(){var z=p.location,A=("state" in history&&history.state!==null),y=z.href,x=t(k);x.addEvent("popstate",function(B){if(!(!A&&z.href===y)){h.noHistory(B.state===null?z.pathname:B.state.url)}A=1});if(!history.pushState){if(z.hash!==""){h.noHistory(z.hash.slice(1))}if("onhashchange" in k){x.addEvent("hashchange",function(B){if(!h.ignore_hash_change){h.noHistory(z.hash.slice(1)||z.pathname)}h.ignore_hash_change=0})}}else{if(history.state&&history.state!==null&&z.href!==y){h.noHistory(history.state.url)}}t(k).addEvent("load",function(){h.dispatchEvent({type:"ready",request:null,target:null})})}());t.ContentContext=h;r=new q(e.getContainer());var w=r.request;r.request=function(y,A,z,x){if(z&&x){r.width=z;r.height=x}w.call(this,y,A)};r.addEvent("afterload",function(x){if(x.target.content_type!=="application/json"||String(x.target.page.content_type).indexOf("text/")===0){e.show("",r.width,r.height)}});r.fromLink=function(B){B=B.elem;var A=400,x=300,y=B.className,z;if(y.indexOf("dim")>-1){z=new RegExp("dim(\\d+)x(\\d+)").exec(y);A=z[1];x=z[2]}this.request(B.getAttribute("href"),null,A,x)};t.BoxingContext=r}});k.Kwf=k.K=t;t(p).addEvent("click",g);t.ready(a.init)}(window,document));
/*!
 * KWF Script: kwf.js
 * Based on DOMcraft
 * 
 * @author Christoffer Lindahl <christoffer@kekos.se>
 * @date 2012-08-21
 * @version 4.0
 */
function elem(b){try{return document.getElementById(b)||document.all[b]}catch(a){return false}}function getTarget(a){a=a||window.event;return a.target||a.srcElement}function returnFalse(a){if(window.event){event.returnValue=false}else{a.preventDefault()}}function addEvent(b,d,c,a){var e=c;if(a){e=function(f){c.call(a,f)}}if(b.addEventListener){b.addEventListener(d,e,0)}else{if(b.attachEvent){b.attachEvent("on"+d,e)}}}function removeEvent(a,c,b){if(a.removeEventListener){a.removeEventListener(c,b,0)}else{if(a.attachEvent){a.detachEvent("on"+c,b)}}}function addSubmitEvent(a,b){addEvent(a,"click",function(c){window.submit_target=getTarget(c)});addEvent(a,"submit",b)}function isWs(a){return !(/[^\t\n\r ]/.test(a.data))}function isIgnorable(a){return(a.nodeType===8)||((a.nodeType===3)&&isWs(a))}function previousNode(a){while(a){if(!isIgnorable(a)){return a}a=a.previousSibling}return null}function nextNode(a){while(a){if(!isIgnorable(a)){return a}a=a.nextSibling}return null}function firstChildElement(b){var a=b.childNodes,d;for(d=0;d<a.length;d++){if(!isIgnorable(a[d])){return a[d]}}return null}function lastChildElement(b){var a=b.childNodes,d;for(d=a.length-1;d>=0;d--){if(!isIgnorable(a[d])){return a[d]}}return null}function hasClass(a,b){return(a.className?a.className.match(new RegExp("(\\s|^)"+b+"(\\s|$)")):0)}function addClass(a,b){if(!hasClass(a,b)){a.className+=" "+b}}function removeClass(a,b){a.className=a.className.replace(new RegExp("(\\s|^)"+b+"(\\s|$)")," ").replace(/\s+/g," ").replace(/^\s|\s$/,"")}function replaceClass(b,a,c){removeClass(b,a);addClass(b,c)}function giveOpacity(a,b){if(typeof a.filters==="object"){a.style.filter="progid:DXImageTransform.Microsoft.Alpha(opacity="+b+")"}}function parseJSON(j){try{j=JSON.parse(j)}catch(e){try{j=eval("("+j+")")}catch(e2){}}return j}function var_dump(b,g){function a(h){var j,k="";for(j=0;j<(h*2);j++){k+=" "}return k}var e=typeof b,f="",d;if(!g){g=1}else{if(g>5){return""}}if(e==="object"){f+="{\n";for(d in b){try{f+=a(g)+d+": "+var_dump(b[d],g+1)}catch(c){}}f+=a(g)+"}"}else{f=b.toString()}f="("+e+") "+f+"\n";if(g===1){alert(f)}else{return f}}function toDOMnode(a){var b=document.createElement("div");b.innerHTML=a;return b.firstChild}function replaceNode(b,c){var a=b.parentNode;a.insertBefore(c,b);a.removeChild(b)}var Ajax=(function(){var b=null,f=null;function d(l,k,u,o,r,m,p){var n=(window.ActiveXObject)?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest(),q,t=0,s;n.open(k,l);n.setRequestHeader("X-ajax-request","true");if(typeof m==="object"){for(s in m){if(m[s][0]==="Content-Type"){t=1}n.setRequestHeader(m[s][0],m[s][1])}}if(!t&&!p){n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=utf-8")}n.onreadystatechange=function(){if(n.readyState===4){t=n.getResponseHeader("Content-Type");t=t.substring(0,t.indexOf(";"));q={page:n.responseText,content_type:t,status:n.status};if(q.content_type==="application/json"){q.page=parseJSON(q.page)}if(f){f()}if(n.status===200){if(n.getResponseHeader("X-ajax-error")){q.success=0;o(q)}else{q.success=1;u(q)}}else{if(n.status===404){q={success:0,page:{error:["Filen hittades inte."]},content_type:"application/json",status:"404"};o(q)}}}};if(b){b()}n.send(r);return n}function g(m){var l="",k;for(k in m){l+="&"+k+"="+encodeURIComponent(m[k])}return l.substring(1)}function e(k,n,l){var m="",p=k.getElementsByTagName("input"),r=k.getElementsByTagName("select"),s=k.getElementsByTagName("textarea"),o;function q(u){var t;if(l){t=(u.name===""?"":'\r\nContent-Disposition: form-data; name="'+u.name+'"\r\n\r\n'+encodeURIComponent(u.value)+"\r\n--"+l)}else{t=(u.name===""?"":"&"+u.name+"="+encodeURIComponent(u.value))}return t}if(k){for(o=0;o<p.length;o++){if(((p[o].type==="radio"||p[o].type==="checkbox")&&!p[o].checked)||(p[o].type==="button"||p[o].type==="submit")){continue}m+=q(p[o])}for(o=0;o<r.length;o++){m+=q(r[o])}for(o=0;o<s.length;o++){m+=q(s[o])}}if(n){m+=q(n)}return m.substring(1)}function c(l,n,k,m){if(typeof m==="object"){m=g(m)}if(m){m="?"+m}else{m=""}return d(l+m,"GET",n,k,null)}function h(l,o,k,n,m){n=(n.nodeType?e(n,m):g(n));return d(l,"POST",o,k,n)}function j(l,v,o,u){if(typeof FormData!=="undefined"&&typeof File!=="undefined"){var r=new FormData();r.append(u.name,u.files[0]);return d(l,"POST",v,o,r,[],1)}else{var t=u.parentNode,m,n,k,q=document.body,p,s=0;if(b){b()}m=q.appendChild(toDOMnode('<form style="visibility: hidden;" action="'+l+'" method="post" enctype="multipart/form-data" target="ajax_upload_frame"><input type="hidden" name="X-ajax-request" value="true" /><input type="hidden" name="X-frame-upload" value="true" /></form>'));t.removeChild(u);m.appendChild(u);n=q.appendChild(toDOMnode('<iframe style="visibility: hidden;" src="javascript: false;" name="ajax_upload_frame" id="ajax_upload_frame"></iframe>'));addEvent(n,"load",function(){setTimeout(function(){k=n.contentDocument||n.contentWindow.document;p=k.body.firstChild.nodeValue;if(p===null){p=k.body.innerHTML}if(p.substring(0,1)==="{"&&p.substring(p.length-1)==="}"){s=1}v({page:(s?parseJSON(p):p),content_type:(s?"application/json":"text/plain"),status:"200"});q.removeChild(n);if(f){f()}},1)});m.submit();q.removeChild(m);t.appendChild(u)}}function a(k){b=k}function i(k){f=k}return{get:c,post:h,upload:j,setBeforeCallback:a,setAfterCallback:i}}()),Boxing=(function(){var h=0,b=0,g=null,c=null,o=null,k=null,a=null,i=null;function e(){return k}function f(){var r,q=[],s;for(r=0;r<a.length;r++){s=a[r].tagName.toLowerCase();if(s.match(/^input|select|textarea|button|a$/)){if((s==="input"&&(a[r].disabled||a[r].type==="hidden"))||(s==="a"&&!a[r].href)){continue}q.push(a[r])}}return q}function d(q){var r=f();return(r.length>0?r[q]:null)}function p(r,q){var s=r.parentNode;if(r!==o){while(s){if(s===k){return}s=s.parentNode}if(q){f().pop().focus()}else{o.focus()}}}function j(){if(h){if(i){if(!i()){return}}c.style.display="none";o.style.display="none";k.style.display="none";k.innerHTML="";g.style.overflow="";i=null;b=0}}function n(q){if(q.keyCode===27){j()}else{if(q.keyCode===9&&b){p(getTarget(q),q.shiftKey)}}}function m(){var q=document;c=q.createElement("div");k=q.createElement("div");o=q.createElement("a");c.id="boxing-overlayer";q.body.appendChild(c);giveOpacity(c,60);addEvent(c,"click",j);addEvent(q,"keyup",n);o.id="close_boxing";o.className="hide-boxing";o.href="javascript: void(0);";o.appendChild(q.createTextNode("StÃ¤ng"));q.body.appendChild(o);k.id="boxing-window";q.body.appendChild(k);g=q.getElementsByTagName("HTML")[0];h=1}function l(v,s,q,w){if(!h){m()}if(typeof w!=="undefined"){i=w}var u=(s>100?"px":"%"),r=(q>100?"px":"%"),t;c.style.display="block";o.style.display="block";k.style.display="block";k.style.width=s+u;k.style.height=q+r;if(r==="%"){k.style.margin="0 0 0 -"+(s/2)+u;k.style.top=(100-q)/2+"%"}else{k.style.margin="-"+(q/2)+r+" 0 0 -"+(s/2)+u;k.style.top="50%"}k.innerHTML=v;o.style.top=k.offsetTop-10+"px";o.style.left=k.offsetLeft+k.offsetWidth-10+"px";a=k.getElementsByTagName("*");t=d(0);if(t){t.focus()}g.style.overflow="hidden";b=1}return{show:l,hide:j,getWindow:e}}()),content_request,boxing_request,Kwf={FULLPATH:"",onclick:null,onload:null,info_timer:null,ignore_hash_change:0,clicking:function(b){if(b.button<1){var a=getTarget(b);if(hasClass(a,"nolink")||hasClass(a.parentNode,"nolink")){returnFalse(b)}if(hasClass(a,"hide-boxing")){returnFalse(b);Boxing.hide()}if(Kwf.onclick){Kwf.onclick(b,a)}}},loading:function(f){if(Kwf.onload){Kwf.onload(f)}if(elem("content")){var b=document.location,d=("state" in history&&history.state!==null),a=b.href;function c(e){content_request.load({preventDefault:function(){}},e,1)}addEvent(window,"popstate",function(e){if(!(!d&&b.href===a)){c(e.state===null?b.pathname:e.state.url)}d=1});if(!history.pushState){if(b.hash!==""){c(b.hash.slice(1))}if("onhashchange" in window){addEvent(window,"hashchange",function(e){if(!Kwf.ignore_hash_change){c(b.hash.slice(1)||b.pathname)}Kwf.ignore_hash_change=0})}}else{if(history.state&&history.state!==null){c(history.state.url)}}content_request.findForms();content_request.dispatchEvent("ready")}},hideInfo:function(){var a=elem("errorlist");if(a){a.parentNode.removeChild(a)}a=elem("infolist");if(a){a.parentNode.removeChild(a)}},infoHandler:function(c){var b="",d,a=Kwf;if(c.errors){b+='<ul id="errorlist">';for(d in c.errors){b+="<li>"+c.errors[d]+"</li>"}b+="</ul>"}if(c.info){b+='<ul id="infolist">';for(d in c.info){b+="<li>"+c.info[d]+"</li>"}b+="</ul>"}if(b!==""){a.hideInfo();clearTimeout(a.timer);a.timer=setTimeout(a.hideInfo,10000)}return b},insertInfo:function(b){var a=elem("content");a.insertBefore(toDOMnode(Kwf.infoHandler(b)),a.firstChild)},handleFormErrors:function(d){if(d.form_errors){var g=d.form_errors,b,c,a;for(b in g){a=elem(b);c=document.createElement("span");addClass(c,"form-error");c.innerHTML=g[b];try{a.parentNode.insertBefore(c,a)}catch(f){alert("Element "+b+" not found in page")}}}},removeFormErrors:function(){if(document.getElementsByClassName){var a=document.getElementsByClassName("form-error");while(a[0]){a[0].parentNode.removeChild(a[0])}}}},MultiView={parse:function(b){var f=document.createElement("div"),c,a,e;if(b.content_type==="application/json"){Kwf.insertInfo(b.page);c=b.page.content}else{c=b.page}f.innerHTML=c;a=f.querySelectorAll("*[id]");for(e=0;e<a.length;e++){replaceNode(elem(a[e].id),a[e])}}},KWFEventTarget=function(){var a=this,b={};a.addEventListener=function(c,d){if(typeof b[c]==="undefined"){b[c]=[]}b[c].push(d)};a.removeEventListener=function(e,f){if(b[e] instanceof Array){var c=b[e],d;for(d=0;d<c.length;d++){if(String(c[d])===String(f)){c.splice(d,1);break}}}};a.dispatchEvent=function(f,h){if(typeof f==="string"){f={type:f};if(typeof h!=="undefined"){f.target=h}}if(!f.target){f.target=this}if(!f.type){alert('Request Event object missing "type" property.')}if(b[f.type] instanceof Array){var c=b[f.type],d;for(d=0;d<c.length;d++){try{c[d].call(this,f)}catch(g){alert(g.message+" at line "+(g.lineNumber||"null")+" in file "+(g.fileName||"null"))}}}}},ContentRequest=function(){var a=this,c=null,b=null,d=1;a.response=null;a.form_btn=null;a.load=function(g,h,f){returnFalse(g);c=getTarget(g);b=h;d=f;a.dispatchEvent("beforeload",c);Ajax.get(b,a.parseResponse,a.parseResponse)};a.parseResponse=function(e){var i="",h="",g=elem("content"),f=a.form_btn;Kwf.removeFormErrors();a.response=e;a.dispatchEvent("afterload",c);e=a.response;if(e.content_type==="application/json"){i=Kwf.infoHandler(e.page);if(e.page.content){h=i+e.page.content}}else{h=e.page}if(h===""&&(i!==""||e.page.form_errors)){Kwf.handleFormErrors(e.page);if(i!==""){g.insertBefore(toDOMnode(i),g.firstChild)}}else{g.innerHTML=h;a.findForms()}window.scrollTo(0,0);a.dispatchEvent("ready",c);c=null;a.response=null;if(!d){if(history.pushState){history.pushState({url:b},null,b)}else{Kwf.ignore_hash_change=1;location.hash="#"+b}}if(f){f.disabled="";a.form_btn=null}};a.findForms=function(){var h=elem("content"),f=h.getElementsByTagName("form"),g,j;function e(l){var i=a.form_btn=window.submit_target,k;c=getTarget(l);k=(c.action==="")?document.location.href:c.action;returnFalse(l);i.disabled="disabled";a.dispatchEvent("beforeload",c);Ajax.post(k,a.parseResponse,a.parseResponse,c,i)}for(g=0;g<f.length;g++){j=f[g];if(hasClass(j,"ajax-form")){addSubmitEvent(j,e);removeClass(j,"ajax-form")}}}},BoxingRequest=function(){var a=this,b=null;a.response=null;a.width=0;a.height=0;a.form_btn=null;a.load=function(g,d,f,c){returnFalse(g);b=getTarget(g);a.width=(f||300);a.height=(c||200);a.dispatchEvent("beforeload",b);Ajax.get(d,a.parseResponse,a.parseResponse)};a.parseResponse=function(c){var f="",e="",d=a.form_btn;Kwf.removeFormErrors();a.response=c;a.dispatchEvent("afterload",b);c=a.response;if(c.content_type==="application/json"){f=Kwf.infoHandler(c.page);if(c.page.content){e=f+c.page.content}}else{e=c.page}if(e===""){if(f!==""){elem("content").insertBefore(toDOMnode(f),elem("content").firstChild)}if(c.page.form_errors){Kwf.handleFormErrors(c.page)}else{Boxing.hide()}}else{Boxing.show(e,a.width,a.height);a.findForms()}a.dispatchEvent("ready",b);b=null;a.response=null;if(d){d.disabled="";a.form_btn=null}};a.findForms=function(){var d=Boxing.getWindow().getElementsByTagName("form"),e,f;function c(i){var g=window.submit_target,h;b=getTarget(i);h=(b.action==="")?document.location.href:b.action;returnFalse(i);if(!hasClass(g,"hide-boxing")){g.disabled="disabled";a.form_btn=g;a.dispatchEvent("beforeload",b);Ajax.post(h,a.parseResponse,a.parseResponse,b,g)}}for(e=0;e<d.length;e++){f=d[e];if(hasClass(f,"ajax-form")){addSubmitEvent(f,c);removeClass(f,"ajax-form")}}}};ContentRequest.prototype=new KWFEventTarget();BoxingRequest.prototype=new KWFEventTarget();content_request=new ContentRequest();boxing_request=new BoxingRequest();addEvent(document,"click",Kwf.clicking);addEvent(window,"load",Kwf.loading);